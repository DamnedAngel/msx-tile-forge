name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensure tags are available

      # Install dependencies for all build targets
      - name: 🛠 Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            docker.io \
            flatpak flatpak-builder \
            build-essential devscripts dh-python python3-all \
            gzip
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      # Build all artifacts using Makefile
      - name: 🏗 Build all artifacts
        run: |
          make all

      # Detect version and pre-release status
      - name: 🔍 Determine release version
        id: get_version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            PRERELEASE=false
          else
            VERSION="dev-$(date +%Y%m%d%H%M)"
            PRERELEASE=true
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

      # Create GitHub Release
      - name: 📦 Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: "Release ${{ steps.get_version.outputs.version }}"
          files: deploy/*
          prerelease: ${{ steps.get_version.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
